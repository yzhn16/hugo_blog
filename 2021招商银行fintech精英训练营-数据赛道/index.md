# 2021招商银行FinTech精英训练营 数据赛道

![](https://hexo-img-meurice.oss-cn-beijing.aliyuncs.com/cover/2021Fintech.jpg)
时间序列回归赛题，一个简单的方案分享+指标MAPE翻车记录，B榜Rank53。magic number yyds~

<!--more-->

## 赛题任务
　　本次竞赛给出的数据包含日期、节假日信息、时间段、岗位（含2种岗位A、B）、业务类型和业务量数据。  
 - 任务1：预测未来31天各岗位每天的业务量总量
 - 任务2：预测未来31天各岗位每天每半小时粒度的业务总量


 - A榜：提供2018年1月1日到2020年10月31日的训练数据（train_v1），选手提交2020年11月1日到2020年11月30日的预测结果。
 - B榜：提供2018年1月1日到2020年11月30日的训练数据（train_v2），选手提交2020年12月1日到2020年12月31日的预测结果。


　　本次比赛的线上评价指标为**MAPE**。
$$
\begin{aligned}
MAPE = \frac{1}{N} \sum_{i=1}^{N} \left| \frac{Y_i - \hat{Y_i}}{Y_i + 1} \right| \times 100\%\\
\end{aligned}
$$
## 解决方案
### 任务1
　　简单观察数据可发现，A、B岗位业务量差距较大，故A、B岗位分开建模。
![A岗位日业务量](https://hexo-img-meurice.oss-cn-beijing.aliyuncs.com/fintech2021/A%E5%B2%97%E4%BD%8D%E6%97%A5%E4%B8%9A%E5%8A%A1%E9%87%8F.png)
![B岗位日业务量](https://hexo-img-meurice.oss-cn-beijing.aliyuncs.com/fintech2021/B%E5%B2%97%E4%BD%8D%E6%97%A5%E4%B8%9A%E5%8A%A1%E9%87%8F.png)
　　对于日业务量，我均采用**LightGBM回归模型**进行预测。  
　　考虑到特殊时期对业务量的影响（特别是2020年上半年的Covid-19疫情），仅采用**2018年3月1日至2018年11月30日**的数据作为训练集，采用**2018年12月1日至2018年12月30日**的数据作为验证集（B榜，A榜划分类似，向前推一个月即可）。  
　　特征工程方面，所做的工作并不太多，特征包括**日期特征**（day_of_week、day_of_month...）、**节假日特征**（节假日类型、距离下个工作日的天数、距离下个节假日的天数...）等。  
　　**后处理**是本题上分的一个关键点。观察数据，可以大致推断出接近年底的业务量是一个逐渐升高的趋势，将模型所预测的结果拼接到原数据集后再对整体走势做可视化分析，可以对模型预测结果的合理性做出大致判断。最开始，我尝试对预测的所有结果都乘一个系数（大约1.25左右，具体根据训练集和使用的特征等的不同会有一定的差异），获得了比较大的收益，随后我又对这个系数更加细化，月上旬、中旬、下旬分别乘不同的系数（逐渐递增），也获得了一定的提升，继续细化这个粒度（按周、按日）应该还会有提升，不过我并没有做更多这方面的尝试。  
　　**PS**：关于后处理还有一些比较不寻常的方法，比如老肥将每一条预测结果都加上大小为666的偏移量，同样取得了较好的线上分数...
### 任务2
　　任务2同样采用LightGBM回归模型，训练数据与任务1相同，特征方面主要就增加了periods。由于与任务1相比，任务2的误差较大，所以我将任务2的训练从直接预测业务量改为了**预测当前时间段的业务量占当天全部业务量的比例**，利用到了任务1的预测结果来调整任务2，这样做还一个好处是，任务1、2基本是同增同减的状态。

## 关于指标MAPE
　　本次比赛中，我一开始就错误的将MAPE当作Lgb的metric，后面一直都忽略了这点，导致任务2的预测结果问题很大，特别是业务量较少（接近0）时，对指标的影响非常大。当我任务1优化到0.059时，任务2的MAPE仍为0.20，最终B榜也仅位于第53名，将metric调整为MSE即可。
 - 当实际值为零时，MAPE会采用未定义的值，例如在需求预测中可能会发生这种情况。此外，当实际值非常接近零时，它将采用极值。
 - MAPE是不对称的，它对负误差（当预测值高于实际值时）要比对正误差施加更大的罚款。解释如下：对于过低的预测，百分比误差不能超过100％。虽然没有太高的预测上限。因此，MAPE将偏向于预测不足而不是过度预测的模型。
 - MAPE假定变量的度量单位具有有意义的零值。因此，尽管预测需求并使用MAPE是有意义的，但当预测温度以摄氏度（不仅是那个）表示时，却没有意义，因为温度具有任意零点。
 - MAPE并非到处都是可微的，在将其用作优化标准时可能会导致问题。
